# 병행 제어

> 병행제어란 여러 개의 트랜잭션이 실행될 때 트랜잭션들이 데이터베이스의 **일관성을 파괴하지 않고 다른 트랜잭션에 영향을 주지 않으면서** 트랜잭션을 제어하는 것을 말한다.

## 트랜잭션이 동시에 실행된다면 발생하는 현상들
- Dirty Write
  - 같은 데이터에 대해 동시에 두 개 이상의 트랜잭션이 값을 바꾸고자 할 때 발생되는 현상
- Dirty Read
  - 아직 종료(commit)되지 않은 트랜잭션의 쓰기 내용을 읽는 것으로 비정상적 상태의 데이터를 읽게 되는 현상
- Non-repeatable Read
  - 어떤 트랜잭션에서 동일한 데이터의 값을 매번 읽을 때마다 틀려지는 현상
- Phantom Read
  - 기존 데이터는 동일한데 새로 추가된 값에 의해 데이터 값이 변경되는 현상

## 병행 제어 미보장 시 문제점
- 갱신 손실(Lost Update)
  - 먼저 실행된 트랜잭션의 결과를 나중에 실행된 트랜잭션이 덮어쓸 때 발생하는 오류
- 현황 파악오류(Dirty Read)
  - 트랜잭션의 중간 수행 결과를 다른 트랜잭션이 참조하여 발생하는 오류
- 모순성(Inconsistency)
  - 두 트랜잭션이 동시에 실행되어 데이터베이스의 일관성이 결여되는 오류
- 연쇄복귀(Cascading Rollback)
  - 복수의 트랜잭션이 데이터 공유 시 특정 트랜잭션이 처리를 취소할 경우 트랜잭션이 처리한 곳의 부분을 취소하지 못하는 오류
  - 같은 자원을 사용하는 두개의 트랜잭션 중 한 개의 트랜잭션이 성공적으로 일을 수행하였다 하더라도 다른 트랜잭션이 처리하는 과정에서 실패하게 되면 두 개의 트랜잭션 모두가 복귀되는 현상

## 병행제어 기법
1. 로킹(Locking)  
   로킹이란
      - 트랜잭션이 어떤 데이터에 접근하고자 할 때 로킹을 수행한다.
      - 로킹을 한 트랜잭션만 로킹을 해제할 수 있다.
      - 로킹되어있는 데이터에는 다른 트랜잭션이 접근할 수 없다.
      - 트랜잭션은 로킹이된 데이터에 대해서만 연산을 수행할 수 있다.

   로킹 단위
      - 필드
      - 레코드
      - 파일
      - 데이터베이스
      > 로킹 단위가 크면: 관리하기가 용이(로킹 오버헤드 감소). 하지만 동시성 수준이 떨어진다.  
        로킹 단위가 작으면: 동시성 수준이 높아지지만 관리가 까다롭다(로킹 오버헤드 증가).

   2단계 로킹 규약(Two-Phase Locking Protocol)
      - Lock와 Unlock이 동시에 이루어지면 일관성이 보장되지 않으므로 Lock만 가능한 단계와 Unlock만 가능한 단계를 구분하며 직렬가능성을 보장한다.
      - 하지만 **교착상태**가 발생할 수 있다.
      1. 확장단계: 트랜잭션이 Lock만 할 수 있고 Unlock는 할 수 없다.
      2. 축소단계: 트랜잭션이 Unlock만 할 수 있고 Lock는 할 수 없다. 

2. 타임 스탬프(Time Stamp)
   - 데이터에 접근하는 시간을 미리 정하여 정해진 시간의 순서대로 데이터에 접근하며 수행한다.
   - 직렬가능성을 보장하며 시간을 나눠 사용하기 때문에 교착상태가 발생하지 않는다.
   - 하지만 연쇄복귀를 초래할 수 있다.
3. 낙관적 병행제어(Optimistic Concurrency Control)
   - 트랜잭션 수행 동안은 어떠한 검사도 하지 않고, 트랜잭션 종료 시에 일괄적으로 검사한다.
   - 수행 도중에는 트랜잭션을 위해 유지되는 데이터 항목들의 지역 사본에 대해서만 갱신하고, 트랜잭션이 종료되고 난 후에 직렬화를 검증하여 검증되면 데이터베이스에 한 번에 반영하는 방식이다.
4. 다중 버전 병행제어(Multi-version Concurrency Control)
   - 하나의 데이터 아이템에 대하여 여러 버전의 값을 유지하며 조회성능을 최대한 유지하기 위한 기법
   - 충돌이 발생할 경우 연쇄 복귀가 발생할 수 있는 단점이 있다.


출처  
[[데이터베이스] 병행 제어(Concurrency Control)](https://kosaf04pyh.tistory.com/300)  
[[DB] 9. 트랜잭션(Transaction) - (3) 병행 제어, 로킹, 타임스탬프](https://rebro.kr/163)