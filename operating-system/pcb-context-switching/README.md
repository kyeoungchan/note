# ğŸ“˜ PCBì™€ Context Switching
## â—ï¸ PCB(Process Controll Block)
> PCB: í”„ë¡œì„¸ìŠ¤ì— ëŒ€í•œ ì •ë³´ë¥¼ ì €ì¥í•œ ìë£Œêµ¬ì¡°
- í”„ë¡œì„¸ìŠ¤ í…Œì´ë¸”ì— ì €ì¥ëœë‹¤.
- ì£¼ê¸°ì–µì¥ì¹˜ì—ì„œ ì €ì¥ëœë‹¤.
- ë¬¸ë§¥ êµí™˜(Context Switching)ì„ í•˜ê¸° ìœ„í•´ í•„ìš”í•˜ë‹¤.

### í”„ë¡œì„¸ìŠ¤ì˜ ìƒíƒœ
í”„ë¡œì„¸ìŠ¤ëŠ” ì—¬ëŸ¬ê°€ì§€ ìƒíƒœë¥¼ ê°€ì§€ê³  ìˆë‹¤.
![process_life_cycle](../res/process_life_cycle.png)
1. `new` & `terminated`
   - new: í”„ë¡œì„¸ìŠ¤ê°€ ìƒì„±ëœ ê²ƒì„ ì˜ë¯¸
   - terminated: í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œëœ ê²ƒì„ ì˜ë¯¸
   - ì´ ë‘ ìƒíƒœëŠ” ì„ì‹œì ì¸ ìƒíƒœì´ë©°, ì£¼ë¡œ ë‚˜ë¨¸ì§€ ì„¸ ê°€ì§€ì˜ ê²½ìš°ê°€ ëŒì•„ê°€ë©´ì„œ í”„ë¡œì„¸ìŠ¤ë¥¼ ë™ì‘ì‹œí‚¨ë‹¤.
2. `ready`
   - í”„ë¡œì„¸ìŠ¤ì˜ ì‹¤í–‰ë  ì¤€ë¹„ê°€ ë‹¤ ëœ ìƒíƒœ
   - ì¤€ë¹„ ìƒíƒœì¸ ê²ƒì„ ìŠ¤ì¼€ì¤„ë§(scheduling)í•˜ì—¬ ë””ìŠ¤íŒ¨ì¹˜(dispatch)í•œë‹¤.
     - ìŠ¤ì¼€ì¤„ë§(scheduling): í”„ë¡œì„¸ìŠ¤ë“¤ ì¤‘ì— í•˜ë‚˜ë¥¼ ê³ ë¥´ëŠ” ê²ƒ
     - ë””ìŠ¤íŒ¨ì¹˜(dispatch): ê³ ë¥¸ í”„ë¡œì„¸ìŠ¤ë¥¼ CPUì— í• ë‹¹í•˜ëŠ” ê²ƒ
3. `running` & `waiting`
   - running: í”„ë¡œì„¸ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì¸ ìƒíƒœ
   - waiting: ì‚¬ìš©ìì˜ ì…ë ¥ì„ ê¸°ë‹¤ë¦¬ëŠ” ìƒíƒœ
   - ì˜ˆì‹œ
     > í„°ë¯¸ë„ì—ì„œ í”„ë¡œê·¸ë¨ì„ ë‹¤ìš´ë¡œë“œí•  ë•Œ, í”„ë¡œê·¸ë¨ì„ ë‹¤ìš´ë¡œë“œí•˜ë‹¤ê°€ ì‚¬ìš©ìì˜ í—ˆìš©ì´ í•„ìš”í•œ ìƒí™©ì´ ìˆë‹¤.  
   ê·¸ë•Œ ë‹¤ìš´ë¡œë“œí•˜ëŠ” ì¤‘ì´ running ìƒíƒœì´ê³ , ì‚¬ìš©ìì˜ í—ˆìš©ì´ í•„ìš”í•œ ìƒíƒœë¥¼ waitingì´ë¼ê³  ì´í•´í•˜ë©´ ëœë‹¤. 

### PCBì˜ êµ¬ì¡°
![pcb_structure.png](../res/pcb_structure.png)
- í”„ë¡œì„¸ìŠ¤ ì‹ë³„ì: í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹ë³„í•˜ëŠ” ìš©ë„
- í”„ë¡œì„¸ìŠ¤ ìƒíƒœ: ready, running, waiting ë“±ì˜ ìƒíƒœë¥¼ ê°€ì§„ë‹¤.
- í”„ë¡œê·¸ë¨ ì¹´ìš´í„°: ì´ í”„ë¡œì„¸ìŠ¤ê°€ ë‹¤ìŒì— ì‹¤í–‰í•  ëª…ë ¹ì–´ì˜ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¨ë‹¤.
- CPU ë ˆì§€ìŠ¤í„°

## â—ï¸ Context Switching(ë¬¸ë§¥ êµí™˜)
> CPUê°€ í˜„ì¬ ì‹¤í–‰í•˜ê³  ìˆëŠ” Task(Process, Thread)ì˜ ìƒíƒœë¥¼ ì €ì¥í•˜ê³ , ë‹¤ìŒ ì§„í–‰í•  Taskì˜ ìƒíƒœ ë° Register ê°’ë“¤ì— ëŒ€í•œ ì •ë³´(Context)ë¥¼ ì½ì–´ ìƒˆë¡œìš´ Taskì˜ Context ì •ë³´ë¡œ êµì²´í•˜ëŠ” ê³¼ì •ì„ ë§í•œë‹¤.  
ë‹¤ë¥´ê²Œ ë§í•˜ë©´, CPUê°€ ì´ì „ì˜ í”„ë¡œì„¸ìŠ¤ ìƒíƒœë¥¼ PCBì— ë³´ê´€í•˜ê³ , ë˜ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ì˜ ì •ë³´ë¥¼ PCBì—ì„œ ì½ì–´ ë ˆì§€ìŠ¤í„°ì— ì ì¬í•˜ëŠ” ê³¼ì •ì´ë‹¤.  
ë˜ ë‹¤ë¥´ê²Œ ë§í•˜ë©´, ë‹¤ì¤‘ í”„ë¡œê·¸ë˜ë° ì‹œìŠ¤í…œì—ì„œ CPUê°€ í• ë‹¹ë˜ëŠ” í”„ë¡œì„¸ìŠ¤ë¥¼ ë³€ê²½í•˜ê¸° ìœ„í•´ í˜„ì¬ CPUë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤í–‰ë˜ê³  ìˆëŠ” í”„ë¡œì„¸ìŠ¤ì˜ ìƒíƒœ ì •ë³´ë¥¼ ì €ì¥í•˜ê³ , ì œì–´ê¶Œì„ ISR(ì¸í„°ëŸ½íŠ¸ ì„œë¹„ìŠ¤ ë£¨í‹´)ì—ê²Œ ë„˜ê¸°ëŠ” ì‘ì—…ì„ ë§í•œë‹¤.

- Context: CPUê°€ ë‹¤ë£¨ëŠ” Task(Process / Thread)ì— ëŒ€í•œ ì •ë³´
- ëŒ€ë¶€ë¶„ì˜ ì •ë³´ëŠ” Reigsterì— ì €ì¥ë˜ê³  PCBë¡œ ê´€ë¦¬ëœë‹¤.
- Context Switchingì€ í”„ë¡œì„¸ìŠ¤ê°€ `Ready` -> `Running`, `Running` -> `Ready`, `Running` -> `Block` ì²˜ëŸ¼ ìƒíƒœ ë³€ê²½ ì‹œì— ë°œìƒí•œë‹¤.



![context_switching.png](../res/context_switching.png)
- `idle`: ìœ íœ´ ìƒíƒœ
- `executing`: ì‹¤í–‰ ì¤‘ì¸ ìƒíƒœ
1. `Process P1`ì—ì„œ interruptë‚˜ System Callì„ ë§Œë‚˜ë©´ PCB1ì— í”„ë¡œì„¸ìŠ¤ì˜ ì •ë³´ê°€ ì €ì¥ì´ ëœë‹¤.
2. `Process P2`ì˜ ì •ë³´ë¥¼ ê°€ì§€ê³  ì˜¤ê³ , ìƒíƒœë¥¼ ë³€ê²½í•˜ì—¬ CPUì— í• ë‹¹í•œë‹¤.
3. `Process P2`ì—ì„œ interruptë‚˜ System Callì„ ë§Œë‚˜ë©´ PCB2ì— í”„ë¡œì„¸ìŠ¤ì˜ ì •ë³´ê°€ ì €ì¥ì´ ëœë‹¤. 
4. `Process P1`ì˜ ì •ë³´ë¥¼ ê°€ì§€ê³  ì˜¤ê³ , ìƒíƒœë¥¼ ë³€ê²½í•˜ì—¬ CPUì— í• ë‹¹í•œë‹¤.

### Context Switchingì´ ë°œìƒí•˜ëŠ” ì›ì¸
- ì„ ì í˜• ìŠ¤ì¼€ì¤„ë§ì˜ ë°©ì‹ìœ¼ë¡œ CPU ìŠ¤ì¼€ì¤„ë§ì´ ì§„í–‰ë˜ê¸° ë•Œë¬¸ì´ë‹¤.
- CPUì— ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ í”„ë¡œì„¸ìŠ¤ê°€ í• ë‹¹ë˜ë©´, ê¸°ì¡´ì— ì‹¤í–‰ë˜ê³  ìˆëŠ” í”„ë¡œì„¸ìŠ¤ë¥¼ ì¤‘ì§€í•˜ê³ , ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ í”„ë¡œì„¸ìŠ¤ê°€ ì§„í–‰ì´ ëœë‹¤.
- **ì¤‘ì§€ë˜ëŠ” í”„ë¡œì„¸ìŠ¤ì˜ ì •ë³´ë¥¼ ì €ì¥í•˜ê³ , ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹¤í–‰í•˜ëŠ” ë°©ì‹ì´ `Context Switching`ì´ë‹¤.**

### Context Switchingì˜ ë¬¸ì œì 
- Context Switchingì´ ì¦ìœ¼ë©´ ì˜¤ë²„í—¤ë“œ(Overhead) ë¹„ìš©ì´ ë°œìƒí•˜ì—¬ ì„±ëŠ¥ì´ ë–¨ì–´ì§„ë‹¤.
- ì‹¤í–‰í•  í”„ë¡œì„¸ìŠ¤ì˜ ì •ë³´ë¥¼ PCBì—ì„œ ê°€ì§€ê³  ì˜¬ ë™ì•ˆ CPUì— í• ë‹¹ëœ í”„ë¡œì„¸ìŠ¤ê°€ ì—†ì–´ì„œ ì•„ë¬´ ì¼ë„ í•˜ì§€ ëª»í•˜ê²Œ ëœì–´ ì„±ëŠ¥ ì €í•˜ë¡œ ì´ì–´ì§„ë‹¤.

### Context Switching Cost
> Context Switchingì´ ë°œìƒí•˜ë©´ì„œ ì†Œìš”ë˜ëŠ” Cost
> 1. Cache ì´ˆê¸°í™”
> 2. Memory Mapping ì´ˆê¸°í™”
> 3. ë©”ëª¨ë¦¬ì˜ ì ‘ê·¼ì„ ìœ„í•´ì„œ Kernel ì€ í•­ìƒ ì‹¤í–‰ë˜ì–´ì•¼ í•œë‹¤.
- ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ì— Context Switchingì„ í•˜ì§€ ë§ê³ , **ë‹¨ì¼ Processì— ì—¬ëŸ¬ Threadë¥¼ ìƒì„±í•˜ì—¬ Threadì—ì„œ Context Switchingì„ í•˜ë©´ ëœë‹¤.**
- Threadì˜ ê²½ìš°, Stack ì˜ì—­ì„ ì œì™¸í•œ ëª¨ë“  ë©”ëª¨ë¦¬ ê³µê°„ì„ ê³µìœ í•˜ê³  ìˆì–´, Stack ì˜ì—­ë§Œ ë³€ê²½í•˜ë©´ ë˜ê¸° ë•Œë¬¸ì— Processë³´ë‹¤ ë¹„ìš©ì´ ì ê²Œ ë“ ë‹¤.

**ì¶œì²˜**  
[os_pcb_and_context_switching](https://github.com/devSquad-study/2023-CS-Study/blob/main/OS/os_pcb_and_context_switching.md)  
[[OS] PCBì™€ Context Switching](https://m.blog.naver.com/adamdoha/222019884898)