# 🧑🏻‍💻 복제
- [레디스에서의 복제 구조](#-레디스에서의-복제-구조)
  - [복제 구조 구성하기](#-복제-구조-구성하기)

## ❗️ 레디스에서의 복제 구조
> 대부분의 데이터 저장소 애플리케이션은 자체적으로 복제 기능을 제공한다.  
> 운영중인 서비스에서 복제본 노드를 추가하는 이유는 대부분 다음과 같다.
> - 애플리케이션이 실행 중인 하드웨어는 언제든지 고장날 수 있으므로, 서비스를 안정적으로 운영하기 위해서는 마스터 데이터베이스가 다운됐을 때 대신 사용할 여분의 복제본이 필요하다.
> - 대규모 서비스에서 복제본은 트래픽을 감소시키는 역할을 할 수 있다.  
>   실시간으로 마스터 노드에 접근해 데이터를 가져가는 서비스가 많을 때, 일부 트래픽이 복제본을 바라보게 한다면 부하 분산을 통해 마스터 노드로의 트래픽을 줄일 수 있게 된다.
> - 운영 중인 마스터 노드에서 매번 데이터의 백업을 받는 것은 부담스러운 작업이다.  
>   백업을 복제본에서 수행하면 백업 작업이 서비스에 미치는 영향도를 최소화할 수 있다.

MySQL이나 PostgreSQL은 멀티 마스터 복제 구조를 제공하기 때문에 모든 노드가 마스터이면서 동시에 복제본이 되는 구조가 될 수 있다.  
하지만 레디스는 멀티 마스터 구조를 지원하지 않으며, 마스터는 복제본이 될 수 없다.  
레디스 버전 2.6 이상부터 복제본 노드는 기본으로 읽기 전용으로 동작하기 때문에 데이터를 읽는 커맨드만 수행할 수 있다.  
➡ 모든 데이터의 입력은 마스터 노드에서 이뤄지는 게 일반적이고, 복제본은 마스터에서 변경된 데이터를 그대로 받아온다.

<br>

### ✅ 복제 구조 구성하기
레디스에서 복제를 사용하는 방법은 굉장히 간단하다.  
```redis
REPLICAOF <master-ip> <master-port>
```
![redis_replicaof.jpeg](../../res/redis_replicaof.jpeg)  

위의 그림과 같이 복제본이 될 노드 B에  `REPLICAOF` 커맨드를 입력해 마스터 노드의 정보를 입력하면 복제 연결이 시작된다.  
레디스의 데이터를 업데이트하는 모든 커맨드는 노드 A에서 실행되기 때문에 서비스 애플리케이션은 마스터 노드인 A의 정보를 바라봐야 한다.  
➡ 마스터 A가 예기치 못한 장애로 인해 사용하지 못하게 됐을 때에는 애플리케이션의 연결 설정을 B로 변경하면 서비스를 계속할 수 있다.

<br>

![redis_replica_structure.jpeg](../../res/redis_replica_structure.jpeg)  
레디스에서 마스터에는 여러 개의 복제본이 연결될 수 있으며, 복제본 노드에 새로운 복제본을 추가하는 것도 가능하다.  
하지만 한 개의 복제 그룹에서는 항상 한 개의 마스터 노드만 존재한다.  
가장 상위의 노드인 마스터 노드만 데이터를 업데이트하는 커맨드를 수행할 수 있고, 하위 복제본은 모두 읽기 전용으로 동작하기 때문에 데이터를 일겅가는 커맨드만 수행할 수 있다.

<br>

레디스 6.0 이상부터 도입된 ACL 기능이 아닌 기본적인 패스워드를 사용해서 데이터를 복제할 때에는 `masterauth` 옵션에 패스워드를 입력해야 한다.(ACL 기능은 추후에 다룰 예정)  

![replica_password_setting.jpeg](../../res/replica_password_setting.jpeg)    
레디스에서 `requirepass` 옵션을 이용해 패스워드를 설정할 수 있다.  
➡ 복제본 노드는 `masterpass` 옵션에 마스터의 `requirepass`에 설정된 패스워드 값을 입력해야 한다.  
➡ 해당 값이 없을 때에는 master에 연결해 데이터를 받아갈 수 없다.  

복제본 인스턴스의 설정 파일을 직접 수정한 후 인스턴스를 재시작하거나, 실행 중인 복제본 인스턴스에서는 아래와 같은 방법으로 옵션을 수정한 뒤 설정 파일을 다시 작성할 수도 있다.  
```redis
> CONFIG SET masterauth mypassword
OK

> CONFIG REWRITE
OK
```


<br>

**참고 자료**  
[개발자를 위한 레디스](https://product.kyobobook.co.kr/detail/S000210785682)