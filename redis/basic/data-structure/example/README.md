# 💻 활용 사례

## ✅ `sorted set`을 이용한 실시간 리더보드
리더보드에는 두 가지 유형이 있다.
- 절대적 리더보드(absolute leaderboard): 서비스의 모든 유저를 정렬시켜 상위권의 목록만을 표시
- 상대적 리더보드(relative leaderboard): 사용자의 스코어를 기반으로 다른 사용자와 비교해 순위를 결정하는 형태의 리더보드
  - 사용자가 속한 그룹 내에서 또는 다른 특정 경쟁자와의 스코어 대결에서 상대적인 순위를 제공한다.

레디스의 `sorted set`을 이용하면 데이터는 저장될 때부터 정렬돼 들어가기 때문에 리더보드의 데이터를 읽어오기 위해 매번 데이터를 정렬할 필요가 없다.

```redis
// daily-score:251115에 플레이어 별 점수 입력
127.0.0.1:6379> ZADD daily-score:251115 28 player:286
(integer) 1
127.0.0.1:6379> ZADD daily-score:251115 400 plyaer:234
(integer) 1
127.0.0.1:6379> ZADD daily-score:251115 45 plyaer:101
(integer) 1
127.0.0.1:6379> ZADD daily-score:251115357 plyaer:24
(error) ERR wrong number of arguments for 'zadd' command
127.0.0.1:6379> ZADD daily-score:251115 357 plyaer:24
(integer) 1
127.0.0.1:6379> ZADD daily-score:251115 199 plyaer:143
(integer) 1

// 플레이어 전체 점수에 따른 오름차순 정렬 출력
127.0.0.1:6379> ZRANGE daily-score:251115 0 -1 withscores
 1) "player:286"
 2) "28"
 3) "plyaer:101"
 4) "45"
 5) "plyaer:143"
 6) "199"
 7) "plyaer:24"
 8) "357"
 9) "plyaer:234"
10) "400"

// 상위 3위까지 플레이어 점수 출력
127.0.0.1:6379> ZREVRANGE daily-score:251115 0 2 withscores
1) "plyaer:234"
2) "400"
3) "plyaer:24"
4) "357"
5) "plyaer:143"
6) "199"
```
- `ZRANGE`: 스코어가 낮은 순서부터 출력한다.
- `ZREVRANGE`: 스코어가 높은 순서부터 출력한다.

### ❗️ 데이터 업데이트
데이터를 업데이트해야 한다면 다음 커맨드로 쉽게 변경이 가능하다.
```redis
127.0.0.1:6379> ZADD daily-score:251115 200 player:286
(integer) 0
127.0.0.1:6379> ZREVRANGE daily-score:251115 0 2 withscores
1) "plyaer:234"
2) "400"
3) "plyaer:24"
4) "357"
5) "player:286"
6) "200"
```
`sorted set`은 기본적으로 `set`이기 때문에 데이터는 중복으로 저장되지 않으며, 같은 아이템을 저장하고자 할 때 스코어가 다르면 기존 데이터의 스코어만 신규 입력한 스코어로 입력된다.

<br>

```redis
127.0.0.1:6379> ZINCRBY daily-score:251115 100 plyaer:24
"457"
127.0.0.1:6379> ZREVRANGE daily-score:251115 0 2 withscores
1) "plyaer:24"
2) "457"
3) "plyaer:234"
4) "400"
5) "player:286"
6) "200"

// 참고로 처음에 데이터를 입력할 때부터 player:234가 아니라 plyaer:234 오타를 쳐서 왜 작동 안하지 싶었다.
127.0.0.1:6379> ZRANGE daily-score:251115 0 -1 withscores
 1) "plyaer:101"
 2) "45"
 3) "player:24"
 4) "100"
 5) "plyaer:143"
 6) "199"
 7) "player:286"
 8) "200"
 9) "plyaer:24"
10) "457"
11) "plyaer:234"
12) "400"
```
직접 스코어를 지정하지 않고 `ZINCRBY` 커맨드를 통해 스코어를 증감시킬 수 있다.  

> 관계형 데이터베이스만 이용해 실시간 차트 서비스를 구현하는 것은 까다로운 작업이다.  
> 모든 유저의 변경 데이터는 실시간으로 업데이트돼야 하며, 점수별로 데이터를 정렬해서 가져오는 작업 자체가 관계형 데이터베이스에 상당한 부하를 줄 수 있기 때문이다.

### ❗️ 랭킹 합산
1. 주간 리더보드는 매주 월요일마다 초기화된다고 가정해보자.
2. 25년 12일은 수요일이다.
3. 이날의 주간 리더보드를 확인하려면 10~12일 스코어를 모두 합산해야한다.

> 관계형 데이터베이스에서 이런 주간 누적 랭킹을 구현하려면 하나의 테이블에서 일자에 해당하는 데이터를 모두 가져온 뒤 선수별로 합치고, 이를 다시 정렬하는 작업을 진행해야 할 것이다.


`ZUNIONSTORE`: 지정한 키에 연결된 각 아이템의 스코어를 합산하는 커맨드다.

```redis
// 25.11.10 sorted set 세팅
127.0.0.1:6379> ZADD daily-score:251110 50 player:101 250 player:24
(integer) 2
127.0.0.1:6379> ZRANGE daily-score:251110 0 -1 WITHSCORES
1) "player:101"
2) "50"
3) "player:24"
4) "250"

// 25.11.11 sorted set 세팅
127.0.0.1:6379> ZADD daily-score:251111 200 player:286 350 player:24 400 player:234
(integer) 3
127.0.0.1:6379> ZRANGE daily-score:251111 0 -1 WITHSCORES
1) "player:286"
2) "200"
3) "player:24"
4) "350"
5) "player:234"
6) "400"

// 25.11.12 sorted set 세팅
127.0.0.1:6379> ZADD daily-score:251112 50 player:24 100 player:101 250 player:234
(integer) 3
127.0.0.1:6379> ZRANGE daily-score:251112 0 -1 WITHSCORES
1) "player:24"
2) "50"
3) "player:101"
4) "100"
5) "player:234"
6) "250"
```

<br>

`ZUNIONSTORE <생성할 키 이름> <합산할 키 개수> <합산할 키>...`로 구조가 이루어진다.
```redis
127.0.0.1:6379> ZUNIONSTORE weekly-score:251112 3 daily-score:251110 daily-score:251111 daily-score:251112
(integer) 4

// 3일 치의 점수가 합산된 데이터가 정렬돼 있다.
127.0.0.1:6379> ZREVRANGE weekly-score:251112 0 -1 WITHSCORES
1) "player:24"
2) "650"
3) "player:234"
4) "650"
5) "player:286"
6) "200"
7) "player:101"
8) "150"
```

<br>

`ZUNIONSTORE` 이용할 때 스코어에 가중치도 줄 수 있다.  
만약 25.11.11에 빼빼로데이 기념 2배 이벤트가 적용된다고 가정해보자(빼빼로데이랑 그거랑 뭔 상관인지는 따지지 말자 나도 잘 모르겠다).

```redis
// WEIGHTS 옵션을 이용해 가중치를 줄 수 있다.
127.0.0.1:6379> ZUNIONSTORE weekly-score:251112 3 daily-score:251110 daily-score:251111 daily-score:251112 WEIGHTS 1 2 1
(integer) 4

127.0.0.1:6379> ZREVRANGE weekly-score:251112 0 -1 WITHSCORES
1) "player:234"
2) "1050"
3) "player:24"
4) "1000"
5) "player:286"
6) "400"
7) "player:101"
8) "150"
```

<br>

## ✅ `serted set`을 이용한 최근 검색 기록
**요구 사항**
- 유저별로 다른 키워드 노출
- 검색 내역은 중복 제거
- 가장 최근 검색한 5개의 키워드만 사용자에게 노출

> 관계형 데이터베이스의 테이블에 데이터를 저장한다면 다음과 같은 쿼리문이 필요하게 된다.  
> `SELECT * FROM keyword WHERE user_id = '123' ORDER BY reg_date DESC LIMIT 5;`  
> - 테이블에 저장할 때는 기존에 사용자가 같은 키워드를 검색했었는지 확인한 후 업데이트해주어야 한다.
> - 테이블에 데이터가 무기한으로 쌓이는 것을 방지하기 위해 주기적으로 배치 작업을 돌려 오래된 검색 기록은 삭제해야 한다.
> - 데이터를 가져올 때는 검색한 시점을 기준으로 정렬해야하기 때문에 사용자와 검색 기록이 늘어날수록 많은 데이터를 테이블에서 관리해야한다는 단점이 있다.

```redis
// 데이터 셋팅
127.0.0.1:6379> ZADD search-keyword:123 20251114220913 실버  
(integer) 1
127.0.0.1:6379> ZADD search-keyword:123 20251114220954 에나멜   202511142210002 반지갑 20251115143501 코듀로이 20251115152734 기모후드 
(integer) 4
// 반지갑 데이터 오타쳐서 업데이트
127.0.0.1:6379> ZADD search-keyword:123 20251114221002 반지갑
0

// 가장 최근 5개 데이터 조회
127.0.0.1:6379> ZREVRANGE search-keyword:123 0 4 WITHSCORES
기모후드
20251115152734
코듀로이
20251115143501
반지갑
20251114221002
에나멜
20251114220954
실버
20251114220913
```

<br>

데이터가 6개째 저장되었을 때 가장 오래된 데이터인 0번 인덱스의 데이터를 삭제하면 된다.  
하지만 매번 데이터를 저장할 때 아이템의 개수를 확인해야하는 것이 번거롭다.  
`sorted set`의 음수 인덱스를 사용해서 데이터를 삭제한다면 번거로움을 줄일 수 있다.
```redis
실버 ➡ -6번 인덱스
20251114220913

에나멜 ➡ -5번 인덱스
20251114220954

반지갑 ➡ -4번 인덱스
20251114221002

코듀로이 ➡ -3번 인덱스
20251115143501

기모후드 ➡ -2번 인덱스
20251115152734

버킷햇 ➡ -1번 인덱스
20251115165302
```

<br>

항상 `ZADD`로 데이터를 저장할 때마다 음수 인덱스 -6번째를 삭제하는 로직을 추가하면 유저별 아이템의 개수를 확인하지 않더라도 5개 이상의 데이터가 저장되지 않도록 강제할 수 있다.  
`ZREMRANGEBYRANK key start stop` 커맨드를 사용하면 인덱스의 범위로 아이템을 삭제할 수 있다.

```redis
// 버킷햇 검색
127.0.0.1:6379> ZADD search-keyword:123 20251115165302 버킷햇
1

// -6번째 인덱스 삭제
127.0.0.1:6379> ZREMRANGEBYRANK search-keyword:123 -6 -6
1

// 상위 5개 최근 검색어 조회
127.0.0.1:6379> ZREVRANGE search-keyword:123 0 4 WITHSCORES
버킷햇
20251115165302
기모후드
20251115152734
코듀로이
20251115143501
반지갑
20251114221002
에나멜
20251114220954

// 전체 데이터 조회
127.0.0.1:6379> ZRANGE search-keyword:123 0 -1 WITHSCORES
에나멜
20251114220954
반지갑
20251114221002
코듀로이
20251115143501
기모후드
20251115152734
버킷햇
20251115165302
```
